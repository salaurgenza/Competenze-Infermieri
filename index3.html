<!doctype html>
<html lang="it" class="font-inter">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Valutazione Competenze</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter',sans-serif
        }

        .transition-all {
            transition: all .25s ease
        }

        /* Stile per il toggle (Tailwind-compatible) */
        .competence-toggle:checked + .block {
            background-color: #3b82f6; /* bg-blue-500 */
        }

        .competence-toggle:checked ~ .dot {
            transform: translateX(100%);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100">
    <header class="bg-blue-700 text-white flex items-center justify-between px-6 py-4 shadow">
        <div class="flex items-center space-x-4">
            <h1 class="text-2xl font-semibold">Valutazione Competenze</h1>
            <span id="badgeReparto" class="text-sm px-2 py-1 bg-blue-800/30 rounded hidden"></span>
        </div>
        <div class="flex items-center gap-4">
            <button id="btnImport" class="text-sm bg-white/10 px-3 py-1 rounded hover:bg-white/20">VBHC</button>
            <button id="themeToggle" class="text-xl">üåô</button>
        </div>
    </header>

    <div class="flex min-h-[calc(100vh-64px)]">
        <aside class="w-64 bg-white dark:bg-gray-800 shadow-lg p-5 flex flex-col">
            <h2 class="text-lg font-semibold mb-4 text-blue-700 dark:text-blue-300">UNITA' OPERATIVE</h2>
            <nav class="space-y-3">
                <button class="reparto-btn flex items-center gap-3 w-full text-left px-3 py-2 rounded" data-reparto="Chirurgia Generale">üè• <span>Chirurgie Generali</span></button>
                <button class="reparto-btn flex items-center gap-3 w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700" data-reparto="Chirurgie Specialistiche">‚öïÔ∏è <span>Chirurgie Specialistiche</span></button>
                <button class="reparto-btn flex items-center gap-3 w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700" data-reparto="Day Surgery Oculistica">üëÅÔ∏è <span>Day Surgery Oculistica</span></button>
            </nav>

            <div class="mt-6">
                <button id="btnAddNurseLeft" class="w-full bg-green-600 text-white px-3 py-2 rounded mb-2">‚ûï Aggiungi infermiere</button>
                <button id="btnExportAll" class="w-full bg-gray-200 px-3 py-2 rounded mb-2">Esporta tutti (JSON)</button>
                <button id="btnClearAll" class="w-full bg-red-100 text-red-700 px-3 py-2 rounded">Svuota dati (test)</button>
            </div>
            <div class="space-x-3">
                <a href="report.html" class="bg-white/10 px-3 py-1 rounded">Report</a>
                <button id="clearLocal" class="bg-red-600 px-3 py-1 rounded text-white">Reset dati</button>
            </div>
            <div class="mt-auto text-xs text-center text-gray-500 dark:text-gray-400">¬© 2025 Valutazione Competenze ‚Äì Sistema Formativo</div>
        </aside>

        <main class="flex-1 p-8 space-y-6 overflow-y-auto">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-semibold text-blue-700 dark:text-blue-300">Scheda ‚Äì <span id="currentReparto">Chirurgia Generale</span></h2>
                <div class="flex items-center gap-2">
                    <button id="btnStart" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Inizia valutazione</button>
                    <button id="btnSaveEval" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Salva valutazione</button>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-6">

                <section class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md lg:col-span-1">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-blue-700 dark:text-blue-300">Infermiere</h3>
                        <div class="flex gap-2">
                            <button id="btnEditNurse" class="hidden bg-yellow-500 text-white px-3 py-1 rounded">Modifica</button>
                            <button id="btnDeleteNurse" class="hidden bg-red-500 text-white px-3 py-1 rounded">Elimina</button>
                        </div>
                    </div>
                    <div id="nurseCard" class="text-sm text-gray-600 dark:text-gray-300">Nessun infermiere selezionato</div>
                </section>

                <section class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md lg:row-span-2 lg:col-span-2">
                    <h3 class="text-lg font-semibold text-blue-700 dark:text-blue-300 mb-2">Competenze</h3>
                    <p id="instructions" class="text-sm text-gray-500 mb-4">Premi <b>Inizia valutazione</b> per abilitare le sezioni.</p>
                    <div id="competenceContainer" class="space-y-4 opacity-50 pointer-events-none max-h-[520px] overflow-y-auto"></div>

                    <div class="mt-4 border-t pt-3">
                        <p id="summaryLevel" class="text-lg font-semibold">-</p>
                        <p id="summaryScore" class="text-sm text-gray-500">Punteggio totale: 0</p>
                    </div>
                </section>

                <section class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md lg:col-span-1">
                    <h3 class="text-lg font-semibold text-blue-700 dark:text-blue-300 mb-4">Grafico Radar</h3>
                    <canvas id="radarChart" class="w-full h-64"></canvas>
                    <div class="mt-4 space-y-2">
                        <button id="btnExportJSON" class="w-full bg-gray-200 dark:bg-gray-700 px-3 py-2 rounded">Esporta valutazione (JSON)</button>
                    </div>
                </section>
            </div>

            <section class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-blue-700 dark:text-blue-300">Elenco Infermieri</h3>
                    <div class="text-sm text-gray-500">Seleziona per modificare o valutare</div>
                </div>
                <div id="nursesList" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
            </section>
        </main>
    </div>

    <div id="modalNurse" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-96 shadow-lg">
            <h3 id="modalTitle" class="text-xl font-semibold mb-4 text-blue-700 dark:text-blue-300">
                Aggiungi Infermiere
            </h3>

            <div class="space-y-2">
                <input id="inputNome" class="w-full p-2 border rounded" placeholder="Nome">
                <input id="inputCognome" class="w-full p-2 border rounded" placeholder="Cognome">
                <input id="inputEsperienza" type="number" min="0" class="w-full p-2 border rounded" placeholder="Esperienza (anni)">
                <input id="inputMatricola" class="w-full p-2 border rounded" placeholder="Matricola">
                <input id="inputRuolo" class="w-full p-2 border rounded" placeholder="Ruolo">
                <input id="inputReparto" class="w-full p-2 border rounded" placeholder="Reparto">
                <input id="inputValutatore" class="w-full p-2 border rounded" placeholder="Valutatore">
            </div>

            <div class="mt-5 flex justify-end gap-2">
                <button id="modalCancel" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded">
                    Annulla
                </button>
                <button id="modalSave" class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded">
                    Salva
                </button>
            </div>
        </div>
    </div>
    <div id="competenceModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col overflow-hidden transform transition-all duration-300 scale-95 opacity-0" id="modalContentContainer">

            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center sticky top-0 bg-white dark:bg-gray-800 z-10">
                <h2 id="modalTitle" class="text-xl font-bold text-blue-700 dark:text-blue-300">Valutazione Dettagliata</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div id="modalBody" class="p-6 overflow-y-auto flex-grow">
                <p class="text-gray-500">Caricamento...</p>
            </div>

            <div class="p-4 border-t border-gray-200 dark:border-gray-700 sticky bottom-0 bg-white dark:bg-gray-800 z-10 text-right">
                <button onclick="closeModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors shadow-md">
                    Chiudi e Salva Punteggi
                </button>
            </div>

        </div>
    </div>

    <script>// ---------- Utility & Data ----------
        function uid() {
            return 'n_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
        }

        const STORAGE_KEY = 'valutazioni_dashboard_v2';

        // Mappatura fissa dei livelli (USATA PER LA VISUALIZZAZIONE E IL SALVATAGGIO)

        const LEVEL_MAP = {
            1: '1 - Supervisione Diretta',
            2: '2 - Supervisione Indiretta',
            3: '3 - Professionista Autonomo',
            4: '4 - Autonomo e Formatore'
        };

        // Funzione per convertire il punteggio (o la media) nel testo del livello
        function scoreToLevelText(score) {
            // Arrotonda per eccesso per decidere il livello (es. 2.1 -> 3)
            const level = Math.ceil(score);
            // Assicura che il livello sia tra 1 e 4
            const clampedLevel = Math.min(4, Math.max(1, level));
            return LEVEL_MAP[clampedLevel] || 'Livello non definito';
        }


        // STRUTTURA DATI AGGIORNATA: Mappa le competenze per reparto
        const COMPETENCE_DATA = {
            "Chirurgia Generale": [
                {
                    key: 'Chirurgia Addominale',
                    questions: [
                        'Esecuzione di procedure chirurgiche a complessit√† media (es. ernia, colecistectomia laparoscopica)',
                        'Assistenza in procedure chirurgiche maggiori (es. resezioni intestinali, chirurgia oncologica)',
                        'Gestione strumentale in emergenza/urgenza non traumatica'
                    ]
                },
                {
                    key: 'Chirurgia Toracica',
                    questions: [
                        'Biopsia del linfonodo sentinella, escissione nodulo mammario, quadrantectomia mammaria',
                        'Mastectomia semplice/radicale, linfoadenectomia ascellare'
                    ]
                },
                {
                    key: 'Chirurgia Senologica',
                    questions: [
                        'Biopsia del linfonodo sentinella, escissione nodulo mammario, quadrantectomia mammaria',
                        'Mastectomia semplice/radicale, linfoadenectomia ascellare'
                    ]
                },
                {
                    key: 'Chirurgia Pediatrica',
                    questions: [
                        'Biopsia del linfonodo sentinella, escissione nodulo mammario, quadrantectomia mammaria',
                        'Mastectomia semplice/radicale, linfoadenectomia ascellare'
                    ]
                }
            ],
            "Chirurgie Specialistiche": [
                {
                    key: 'Ch. Senologica', questions: [
                        'Biopsia del linfonodo sentinella, escissione nodulo mammario, quadrantectomia mammaria',
                        'Mastectomia semplice/radicale monolaterale/bilaterale, linfoadenectomia ascellare monolaterale/bilaterale',
                        'Quadrantectomia mammaria con mastoplastica riduttiva, mastectomia nipple sparing or skin sparing/reducing monolaterale/bilaterale'
                    ]
                },
                {
                    key: 'Ch. plastica', questions: [
                        'Asportazione radicale di lesione della cute, allargamento cicatrice chirurgia pregresso melanoma e biopsia del linfonodo sentinella',
                        'Liposuzione in esiti chirurgia bariatrica e della mammella, lifting braccia-addome e cosce, rimozione protesi della mammella, inserzione di espansore tissutale della mammella mono/bilaterale',
                        'Asportazione neoformazioni cutanee estese con innesto lembo di scorrimento',
                        'Mastopessi/mastoplastica riduttiva mono-bilaterale, ricostruzione mammaria con protesi mono/bilaterale',
                        'Anastomosi venolinfatiche per linfedema arto inferiore/superiore, lembo microchirurgico/peduncolato per ricostruzione mammaria, ricostruzione con innesto cutaneo/lembo locale a distanza-microvascolare del perineo e della vulva'
                    ]
                },
                {
                    key: 'Ortopedia e Traumatologia',
                    questions: [
                        'CHIRURGIA OMERO frattura, pseudoartrosi, neoformazione, infezioni osteo-articolari: sintesi percutanea con fissatore esterno, sintesi con placca e viti/chiodo endomidollare, osteotomia, rimozione mezzi di sintesi, biopsia percutanea/open e asportazione neoformazioni muscolo-scheletriche, innesti ossei, amputazione, impianto spaziatore',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                    ]
                },
                {
                    key: 'Chirurgia Vertebrale',
                    questions: [
                        'CHIRURGIA VERTEBRALE BASE biopsia percutanea/open, cifoplastica vertebroplastica, microdiscectomia',
                        '..............',
                        '..............'
                    ]
                },
                {
                    key: 'Neurochirurgia',
                    questions: [
                        'CHIRURGIA DELL/IDROCEFALO: derivazioni lombo-peritoneali, ventricolo-atriali, ventricolo-peritoneali, derivazione ventricolare esterna',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............'
                    ]
                },
                {
                    key: 'Otorinolaringoiatria',
                    questions: [
                        'CAVO ORALE: adenotonsillectomia, aportazione neoformazione labbro, guancia, lingua e faringea. Uvulofaringopalatoplastica, asportazione corpo estraneo faringeo e laringeo, incisione ascesso tonsillare, marsupializzazione del dotto salivare e dell/ascesso parotideo. Scialoendoscopia, frenuloplastic linguale, riparazione fistola oroantrale e oronasale, asportazione neoformazione del palato duro ,asporazione di ranula sotto liguale e gengivale. MicroLaringoscopia ',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............'
                    ]
                },
                {
                    key: 'Maxillo-Facciale',
                    questions: [
                        'CAVO ORALE:asportazione neoformazione lingua, palato duro, osteolitica mascellare, guancia e labbra. Fistola oro-nasoantrale',
                        '..............',
                        '..............',
                        '..............',
                        '..............',
                        '..............'
                    ]
                }

            ],
            "Day Surgery Oculistica": [
                {
                    key: 'Cataratta',
                    questions: [
                        'Gestione strumentale e assistenza in chirurgia della cataratta',
                        'Assistenza in chirurgia palpebrale e del segmento anteriore',
                        'Gestione delle procedure in anestesia locale'
                    ]
                },
                {
                    key: 'Procedure Minori',
                    questions: [
                        'Piccoli interventi in anestesia locale (es. asportazione di neoformazioni cutanee)',
                        'Gestione del paziente in dimissione rapida'
                    ]
                },
                {
                    key: 'Vitreo retina',
                    questions: [
                        'Gestione degli strumenti per vitrectomia (es. microscopio, vitrectore, gas/olio)',
                        'Assistenza in procedure complesse (es. distacco di retina, membrane epiretiniche)',
                        'Gestione del monitoraggio intraoperatorio per interventi di retina'
                    ]
                },
                {
                    key: 'Glaucoma',
                    questions: [
                        'Preparazione e assistenza per interventi di filtraggio (es. trabeculectomia)',
                        'Assistenza per l‚Äôimpianto di dispositivi di drenaggio (es. shunt valvolari)',
                        'Gestione delle complicanze post-operatorie immediate (es. ipotonia, ipertonia)'
                    ]
                },
                {
                    key: 'Cornea',
                    questions: [
                        'Assistenza strumentale per trapianti di cornea (es. PKP, DMEK/DSAEK)',
                        'Gestione di procedure laser di superficie (es. PRK, PTK)',
                        'Cura e gestione del paziente con medicazioni complesse o lenti a contatto terapeutiche'
                    ]
                }
            ]

        };

        // Calcola il punteggio massimo per ogni reparto
        const MAX_SCORES = {};
        for (const reparto in COMPETENCE_DATA) {
            let totalQuestions = 0;
            COMPETENCE_DATA[reparto].forEach(area => {
                totalQuestions += area.questions.length;
            });
            MAX_SCORES[reparto] = totalQuestions * 4; // Max score √® 4 per domanda
        }

        const ALL_REPARTI = Object.keys(COMPETENCE_DATA);
        const data = loadData();
        let currentReparto = ALL_REPARTI[0] || 'Chirurgia Generale'; // Default al primo reparto
        let selectedNurseId = null;
        let isEditing = false;

        // Funzione per ottenere le competenze correnti
        function getCurrentCompetences() {
            return COMPETENCE_DATA[currentReparto] || [];
        }

        // Funzione per ottenere il punteggio massimo corrente
        function getCurrentMaxScore() {
            return MAX_SCORES[currentReparto] || 4;
        }

        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

        function loadData() {
            const raw = localStorage.getItem(STORAGE_KEY);
            const loaded = raw ? JSON.parse(raw) : {};

            // Inizializza i dati per tutti i reparti se non esistono
            ALL_REPARTI.forEach(reparto => {
                if (!loaded[reparto]) {
                    loaded[reparto] = {
                        infermieri: [],
                        competenze: COMPETENCE_DATA[reparto].map(area => ({
                            title: area.key,
                            items: area.questions.map(q => ({ text: q, values: [1, 2, 3, 4] }))
                        }))
                    };
                }
            });
            return loaded;
        }


        // ---------- Elements ----------
        const nursesList = document.getElementById('nursesList');
        const nurseCard = document.getElementById('nurseCard');
        const competenceContainer = document.getElementById('competenceContainer');
        const summaryScore = document.getElementById('summaryScore');
        const summaryLevel = document.getElementById('summaryLevel');
        const currentRepartoEl = document.getElementById('currentReparto');
        const radarCtx = document.getElementById('radarChart').getContext('2d');
        let radarChart = null;

        // Modal elements
        const modalNurse = document.getElementById('modalNurse');
        const modalTitle = document.getElementById('modalTitle');
        const inputNome = document.getElementById('inputNome');
        const inputCognome = document.getElementById('inputCognome');
        const inputEsperienza = document.getElementById('inputEsperienza');
        const inputMatricola = document.getElementById('inputMatricola');
        const inputRuolo = document.getElementById('inputRuolo');
        const inputValutatore = document.getElementById('inputValutatore');
        const inputReparto = document.getElementById('inputReparto');


        // ---------- Rendering ----------
        function renderNurses() {
            nursesList.innerHTML = '';
            // Filtra gli infermieri in base al reparto corrente
            const list = (data[currentReparto] && data[currentReparto].infermieri) || [];

            if (list.length === 0) { nursesList.innerHTML = `<div class="text-sm text-gray-500">Nessun infermiere trovato nel reparto ${currentReparto}.</div>`; }
            list.forEach(n => {
                const card = document.createElement('div');
                const selectedClass = n.id === selectedNurseId ? 'bg-blue-200 dark:bg-blue-600' : 'bg-gray-50 dark:bg-gray-700';
                card.className = `p-3 ${selectedClass} rounded shadow-sm hover:scale-[1.01] transition-transform cursor-pointer`;
                card.innerHTML = `<div class='font-semibold'>${n.nome} ${n.cognome}</div><div class='text-xs text-gray-500'>${n.ruolo || ''} ${n.matricola ? ' - ' + n.matricola : ''}</div>`;
                card.addEventListener('click', () => selectNurse(n.id));
                nursesList.appendChild(card);
            });
        }

        // Funzione di rendering delle competenze con switch (gi√† ottimizzata)
        function renderCompetences() {
            competenceContainer.innerHTML = '';
            const comps = getCurrentCompetences().map(area => ({
                title: area.key,
                items: area.questions.map(q => ({ text: q, values: [1, 2, 3, 4] }))
            }));

            comps.forEach((sec, sIdx) => {
                const uniqueId = `sec_${currentReparto.replace(/\s/g, '_')}_${sIdx}`;
                const secWrap = document.createElement('div');
                secWrap.className = 'border rounded p-3 bg-white/50 dark:bg-gray-800 transition-all';

                // Header con Titolo e Toggle
                const header = document.createElement('div');
                header.className = 'flex items-center justify-between cursor-pointer';
                header.innerHTML = `
                    <h4 class='font-semibold'>${sec.title}</h4>
                    <label class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="${uniqueId}_toggle" class="sr-only competence-toggle">
                            <div class="block bg-gray-600 w-10 h-6 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                        </div>
                    </label>
                `;

                // Contenitore delle domande (inizialmente nascosto e disattivato)
                const list = document.createElement('div');
                list.className = 'mt-4 space-y-4 hidden competence-list';
                list.id = `${uniqueId}_list`;

                sec.items.forEach((it, iIdx) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'border-b pb-2';
                    questionDiv.innerHTML = `<p class='font-medium text-sm mb-2'>${it.text}</p>`;

                    const radioGroup = document.createElement('div');
                    radioGroup.className = 'flex gap-4 justify-between text-xs';

                    it.values.forEach(val => {
                        const radioId = `r_${currentReparto.replace(/\s/g, '_')}_${sIdx}_${iIdx}_${val}`;
                        const radioName = `radio_${currentReparto.replace(/\s/g, '_')}_${sIdx}_${iIdx}`;

                        const label = document.createElement('label');
                        label.className = 'flex items-center gap-1 cursor-pointer';
                        label.innerHTML = `
                                    <input type='radio' id='${radioId}' name='${radioName}' data-section='${sIdx}' data-item='${iIdx}' data-value='${val}' class='competenza-radio' disabled>
                                    <span>${val}</span>
                                `;
                        radioGroup.appendChild(label);
                    });

                    questionDiv.appendChild(radioGroup);
                    list.appendChild(questionDiv);
                });

                secWrap.appendChild(header);
                secWrap.appendChild(list);
                competenceContainer.appendChild(secWrap);

                // Aggiungi listener per il toggle
                const toggleInput = document.getElementById(`${uniqueId}_toggle`);
                const radioInputs = list.querySelectorAll('.competenza-radio');

                toggleInput.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    list.classList.toggle('hidden', !isChecked);
                    secWrap.classList.toggle('bg-white/50', !isChecked);
                    secWrap.classList.toggle('bg-blue-50/70', isChecked); // Colore di sfondo per competenza attiva

                    // Abilita/Disabilita i radio button e rimuovi selezione se disattivato
                    radioInputs.forEach(radio => {
                        radio.disabled = !isChecked;
                        if (!isChecked) {
                            radio.checked = false; // Rimuove la selezione se disattivato
                        }
                    });
                    updateScores(); // Aggiorna i punteggi dopo l'attivazione/disattivazione
                });
            });
            // bind change per tutti i radio button
            document.querySelectorAll('.competenza-radio').forEach(rb => rb.addEventListener('change', updateScores));
        }

        function updateNurseCard() {
            if (!selectedNurseId) { nurseCard.innerHTML = 'Nessun infermiere selezionato'; document.getElementById('btnEditNurse').classList.add('hidden'); document.getElementById('btnDeleteNurse').classList.add('hidden'); return; }
            // Cerca l'infermiere nel reparto corrente
            const n = data[currentReparto].infermieri.find(x => x.id === selectedNurseId);
            if (!n) return;
            nurseCard.innerHTML = `
                            <div class='font-medium text-lg'>${n.nome} ${n.cognome}</div>
                            <div class='text-sm text-gray-600'>${n.ruolo || '-'} | Matricola: ${n.matricola || '-'}</div>
                            <div class='text-sm mt-2'>Esperienza: ${n.esperienza || '-'} anni</div>
                            <div class='text-sm mt-2 text-gray-500'>Ultima valutazione: ${n.ultimaValutazione && n.ultimaValutazione.reparto === currentReparto ? n.ultimaValutazione.data : 'Mai (o in altro reparto)'}</div>`;
            document.getElementById('btnEditNurse').classList.remove('hidden'); document.getElementById('btnDeleteNurse').classList.remove('hidden');
        }

        // Funzione per selezionare il reparto e ricaricare tutti gli elementi
        function selectReparto(name, isInitial = false) {
            currentReparto = name;
            currentRepartoEl.textContent = name;

            // Gestisce l'evidenziazione del pulsante cliccato
            document.querySelectorAll('.reparto-btn').forEach(b => {
                b.classList.remove('bg-blue-100', 'dark:bg-blue-900');
                if (b.dataset.reparto === name) {
                    b.classList.add('bg-blue-100', 'dark:bg-blue-900');
                }
            });

            // Resetta la selezione infermiere e aggiorna la UI
            selectedNurseId = null;
            updateNurseCard();
            renderNurses();
            renderCompetences();
            resetScores();
        }

        function selectNurse(id) {
            selectedNurseId = id;
            updateNurseCard();
            loadNurseEvaluation();
            renderNurses();
        }

        // Funzione per aprire il modal infermiere (Riferimenti a 'classe' e 'classeManuale' rimossi)
        function openNurseModal(edit = false) {
            isEditing = edit;
            modalNurse.classList.remove('hidden'); modalNurse.classList.add('flex');
            if (edit && selectedNurseId) {
                const n = data[currentReparto].infermieri.find(x => x.id === selectedNurseId);
                modalTitle.textContent = 'Modifica infermiere'; inputNome.value = n.nome; inputCognome.value = n.cognome; inputEsperienza.value = n.esperienza || '';
                inputMatricola.value = n.matricola || ''; inputRuolo.value = n.ruolo || ''; inputValutatore.value = n.valutatore || ''; inputReparto.value = n.reparto || currentReparto;
                // Rimosso riferimento a n.classeManuale
            } else {
                modalTitle.textContent = 'Aggiungi infermiere'; inputNome.value = ''; inputCognome.value = ''; inputEsperienza.value = ''; inputMatricola.value = ''; inputRuolo.value = ''; inputValutatore.value = ''; inputReparto.value = currentReparto;
                // Rimosso riferimento a document.getElementById('classe').value
            }
        }
        function closeNurseModal() { modalNurse.classList.add('hidden'); modalNurse.classList.remove('flex'); }

        // ---------- Actions ----------
        document.getElementById('btnAddNurseLeft').addEventListener('click', () => openNurseModal(false));
        document.getElementById('btnEditNurse').addEventListener('click', () => {
            if (!selectedNurseId) { alert('Seleziona un infermiere'); return; } openNurseModal(true);
        });
        document.getElementById('modalCancel').addEventListener('click', closeNurseModal);

        // Funzione di salvataggio modal (Riferimenti a 'classe' e 'classeManuale' rimossi)
        document.getElementById('modalSave').addEventListener('click', () => {
            const nome = inputNome.value.trim(); const cognome = inputCognome.value.trim();
            if (!nome || !cognome) { alert('Nome e cognome obbligatori'); return; }
            const repartoValue = inputReparto.value.trim() || currentReparto;
            // Rimosso: const classeSelezionata = document.getElementById('classe').value;

            // Logica di salvataggio: l'infermiere viene salvato nel reparto indicato nel modal/o corrente
            if (!data[repartoValue]) {
                data[repartoValue] = { infermieri: [], competenze: COMPETENCE_DATA[repartoValue] ? COMPETENCE_DATA[repartoValue].map(area => ({ title: area.key, items: area.questions.map(q => ({ text: q, values: [1, 2, 3, 4] })) })) : { infermieri: [] } };
            }

            if (isEditing && selectedNurseId) {
                // Rimuovi dal vecchio reparto e aggiungi al nuovo, se il reparto √® cambiato
                const oldReparto = data[currentReparto].infermieri.find(x => x.id === selectedNurseId)?.reparto || currentReparto;
                if (oldReparto !== repartoValue) {
                    data[oldReparto].infermieri = data[oldReparto].infermieri.filter(x => x.id !== selectedNurseId);
                }

                const infermieriList = data[repartoValue].infermieri;
                let idx = infermieriList.findIndex(x => x.id === selectedNurseId);

                if (idx !== -1) {
                    const updated = {
                        ...infermieriList[idx],
                        nome, cognome, esperienza: inputEsperienza.value, matricola: inputMatricola.value,
                        ruolo: inputRuolo.value, valutatore: inputValutatore.value,
                        reparto: repartoValue,
                        // classeManuale Rimosso
                    };
                    infermieriList[idx] = updated;
                } else {
                    // Se l'infermiere non esiste nel nuovo reparto, ricrealo (caso di cambio reparto)
                    const n = { id: selectedNurseId, nome, cognome, esperienza: inputEsperienza.value, matricola: inputMatricola.value, ruolo: inputRuolo.value, valutatore: inputValutatore.value, reparto: repartoValue, valutazioni: [], ultimaValutazione: null }; // classeManuale Rimosso
                    infermieriList.push(n);
                }

                saveData();
                selectReparto(currentReparto); // Ricarica il reparto corrente
                selectNurse(selectedNurseId); // Ricarica l'infermiere selezionato
                closeNurseModal();

            } else {
                const newN = {
                    id: uid(), nome, cognome, esperienza: inputEsperienza.value, matricola: inputMatricola.value,
                    ruolo: inputRuolo.value, valutatore: inputValutatore.value, reparto: repartoValue,
                    // classeManuale Rimosso
                    valutazioni: [], ultimaValutazione: null
                };
                data[repartoValue].infermieri.push(newN);
                saveData();
                selectReparto(repartoValue); // Seleziona il reparto appena aggiunto
                selectNurse(newN.id);
                closeNurseModal();
            }
        });

        document.getElementById('btnDeleteNurse').addEventListener('click', () => {
            if (!selectedNurseId) return; if (!confirm('Confermi eliminazione infermiere?')) return;
            data[currentReparto].infermieri = data[currentReparto].infermieri.filter(x => x.id !== selectedNurseId); selectedNurseId = null; saveData(); renderNurses(); updateNurseCard(); resetScores();
        });

        document.getElementById('btnStart').addEventListener('click', () => {
            if (!selectedNurseId) { alert('Seleziona un infermiere prima di iniziare'); return; }
            competenceContainer.classList.remove('opacity-50'); competenceContainer.classList.remove('pointer-events-none'); document.getElementById('instructions').textContent = 'Compila le competenze selezionando un livello (1-4) per ogni domanda.';
        });

        // Funzione di salvataggio valutazione (gi√† ottimizzata per i toggle)
        document.getElementById('btnSaveEval').addEventListener('click', () => {
            if (!selectedNurseId) { alert('Seleziona infermiere'); return; }

            const { scores, sectionDetails } = computeSectionScores();
            const total = scores.reduce((a, b) => a + b, 0);

            const nurse = data[currentReparto].infermieri.find(x => x.id === selectedNurseId);

            // Controlla che le sezioni ATTIVATE siano tutte risposte
            const missingResponses = sectionDetails.filter(d => {
                const toggleId = `sec_${currentReparto.replace(/\s/g, '_')}_${sectionDetails.findIndex(s => s.key === d.key)}_toggle`;
                const isSectionActive = document.getElementById(toggleId)?.checked || false;
                return isSectionActive && d.answeredCount < d.questionsCount;
            });

            if (missingResponses.length > 0) {
                alert(`Attenzione: devi rispondere a TUTTE le domande nelle sezioni attivate.`);
                return;
            }

            // Prepara i dati della valutazione
            const selectedRadios = Array.from(document.querySelectorAll('.competenza-radio:checked')).map(rb => ({
                sectionIndex: rb.dataset.section,
                itemIndex: rb.dataset.item,
                value: Number(rb.dataset.value)
            }));

            // Salva lo stato dei toggle attivati
            const activeToggles = Array.from(document.querySelectorAll('.competence-toggle:checked')).map(toggle => toggle.id);


            const valutazione = {
                data: (new Date()).toLocaleString(),
                reparto: currentReparto,
                sections: sectionDetails, // Salva il dettaglio delle sezioni
                total,
                selections: selectedRadios,
                activeToggles: activeToggles // Salva lo stato dei toggle
            };

            nurse.valutazioni = nurse.valutazioni || [];
            // Filtra la valutazione precedente se esiste e sostituisci (per tenere solo l'ultima)
            const otherValuations = nurse.valutazioni.filter(v => v.reparto !== currentReparto);
            nurse.valutazioni = [...otherValuations, valutazione];


            // Salva l'ultima valutazione (sostituisce quella precedente per il reparto corrente)
            nurse.ultimaValutazione = valutazione;

            saveData();
            updateNurseCard();
            alert(`Valutazione salvata. I dati sono pronti per report.html.`);
        });

        // Export e Clear (omessi per brevit√†, sono gli stessi)
        document.getElementById('btnExportAll').addEventListener('click', () => {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'valutazioni_all.json'; a.click(); URL.revokeObjectURL(url);
        });

        document.getElementById('btnExportJSON').addEventListener('click', () => {
            if (!selectedNurseId) { alert('Seleziona infermiere'); return; }
            const nurse = data[currentReparto].infermieri.find(x => x.id === selectedNurseId); const blob = new Blob([JSON.stringify({ nurse, reparto: currentReparto }, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${nurse.nome}_${nurse.cognome}_valutazione.json`; a.click(); URL.revokeObjectURL(url);
        });

        document.getElementById('btnClearAll').addEventListener('click', () => { if (!confirm('Svuotare tutti i dati locali?')) return; localStorage.removeItem(STORAGE_KEY); location.reload(); });

        // Calcolo punteggi per sezione (gi√† ottimizzata)
        // Funzione per calcolare i punteggi per sezione e item
        function computeSectionScores() {
            const comps = COMPETENCE_DATA[currentReparto] || [];
            const scores = [];
            const sectionDetails = [];
            const itemDetails = []; // Nuovo array per i dettagli delle singole domande

            comps.forEach((s, sIdx) => {
                let sum = 0;
                let answeredQuestions = 0;
                const radioGroupNamePrefix = `radio_${currentReparto.replace(/\s/g, '_')}_${sIdx}_`;
                const toggleId = `sec_${currentReparto.replace(/\s/g, '_')}_${sIdx}_toggle`;
                const isSectionActive = document.getElementById(toggleId)?.checked || false;

                const currentSectionItems = []; // Dettagli item per la sezione corrente

                s.questions.forEach((item, iIdx) => {
                    const radioName = `${radioGroupNamePrefix}${iIdx}`;
                    const selectedRadio = document.querySelector(`input[name='${radioName}']:checked`);
                    let value = 0;
                    let levelText = 'Non risposto';

                    if (isSectionActive && selectedRadio) {
                        value = Number(selectedRadio.dataset.value || 0);
                        sum += value;
                        answeredQuestions++;
                        // Il livello per item √® la mappatura diretta del punteggio (1: diretta, 2: indiretta, etc.)
                        levelText = scoreToLevelText(value);
                    } else if (!isSectionActive) {
                        levelText = 'Non Valutato';
                    }

                    currentSectionItems.push({
                        question: item,
                        score: value,
                        level: levelText
                    });
                });

                itemDetails.push({ key: s.key, questions: currentSectionItems }); // Salva i dettagli di tutti gli item della sezione

                const totalQuestions = s.questions.length;
                // Calcolo della media solo se la sezione √® attiva
                const averageScore = isSectionActive && answeredQuestions > 0 ? sum / answeredQuestions : 0;

                // Livello riassuntivo del gruppo (solo se ci sono risposte valide)
                const groupLevelText = isSectionActive && answeredQuestions > 0 ? scoreToLevelText(averageScore) : (isSectionActive ? 'Non Completo' : 'Non Valutato');

                scores.push(sum);
                sectionDetails.push({
                    key: s.key,
                    score: sum,
                    level: groupLevelText,
                    questionsCount: totalQuestions,
                    answeredCount: answeredQuestions,
                    average: averageScore
                });
            });
            return { scores, sectionDetails, itemDetails }; // Restituisce i dettagli degli item
        }

        // Aggiornamento UI punteggi e livelli (gi√† ottimizzata)
        // Funzione per aggiornare il riepilogo
        function updateScores() {
            const { scores, sectionDetails, itemDetails } = computeSectionScores();
            const total = scores.reduce((a, b) => a + b, 0);
            const totalMaxScore = getCurrentMaxScore();

            summaryScore.textContent = `Punteggio totale: ${total} (Max: ${totalMaxScore})`;

            // Costruisce il riepilogo dettagliato per ogni item
            let summaryHtml = '';

            itemDetails.forEach(section => {
                // Mostra il titolo del gruppo/competenza
                summaryHtml += `<h4 class='font-semibold mt-4 mb-1 text-blue-700 dark:text-blue-300'>${section.key}</h4>`;

                // Dettaglio per singola domanda
                section.questions.forEach(item => {
                    const isAnswered = item.score > 0;
                    const color = isAnswered ? (item.score >= 3 ? 'text-green-600 dark:text-green-400' : 'text-blue-600 dark:text-blue-400') : 'text-gray-500 dark:text-gray-400';

                    summaryHtml += `<div class="flex flex-col space-y-0">
                                    <span class="text-xs text-gray-700 dark:text-gray-300">${item.question}</span>
                                    <span class="${color} text-sm font-semibold ml-2">${item.level}</span>
                                </div>`;
                });
            });

            // Aggiorna l'elemento summaryLevel con la nuova struttura
            summaryLevel.innerHTML = `<h4 class='font-semibold mb-2'>Livelli di Riferimento Dettagliati:</h4><div class='space-y-3 text-sm'>${summaryHtml}</div>`;

            // Aggiorna il grafico radar (rimane invariato, usa la media del gruppo)
            const labels = getCurrentCompetences().map(s => s.key);

            if (radarChart) radarChart.destroy();

            // Per il radar, usiamo la media del punteggio per avere un grafico normalizzato (Max 4)
            const dataForRadar = sectionDetails.map(d => d.average);
            const maxRadar = 4;

            radarChart = new Chart(radarCtx, {
                type: 'radar',
                data: { labels: labels, datasets: [{ label: 'Livello Medio', data: dataForRadar, backgroundColor: 'rgba(59,130,246,0.18)', borderColor: '#3b82f6', borderWidth: 1 }] },
                options: { responsive: true, scales: { r: { beginAtZero: true, max: maxRadar } } }
            });
        }

        // Funzione di reset punteggi (gi√† ottimizzata)
        function resetScores() {
            document.querySelectorAll('.competenza-radio').forEach(rb => rb.checked = false);
            document.querySelectorAll('.competence-toggle').forEach(toggle => {
                toggle.checked = false;
                toggle.dispatchEvent(new Event('change')); // Simula il click per disattivare e nascondere
            });

            updateScores();
            document.getElementById('instructions').textContent = 'Premi Inizia valutazione per abilitare le sezioni.';
            competenceContainer.classList.add('opacity-50');
            competenceContainer.classList.add('pointer-events-none');
        }

        // Funzione di caricamento valutazione (gi√† ottimizzata)
        function loadNurseEvaluation() {
            renderCompetences();
            const nurse = data[currentReparto].infermieri.find(x => x.id === selectedNurseId);

            if (!nurse) {
                resetScores();
                return;
            }

            const lastEval = nurse.valutazioni ? nurse.valutazioni.find(v => v.reparto === currentReparto) : null;

            if (!lastEval || !lastEval.selections) {
                resetScores();
                return;
            }

            // 1. Ripristina lo stato dei toggle
            document.querySelectorAll('.competence-toggle').forEach(toggle => {
                const isChecked = lastEval.activeToggles?.includes(toggle.id) || false;
                toggle.checked = isChecked;

                // Attiva la logica di visualizzazione/disattivazione dei radio buttons
                const listId = toggle.id.replace('_toggle', '_list');
                const list = document.getElementById(listId);
                const radioInputs = list.querySelectorAll('.competenza-radio');
                const secWrap = toggle.closest('div.border');

                list.classList.toggle('hidden', !isChecked);
                secWrap.classList.toggle('bg-white/50', !isChecked);
                secWrap.classList.toggle('bg-blue-50/70', isChecked);

                radioInputs.forEach(radio => {
                    radio.disabled = !isChecked;
                });
            });

            // 2. Ripristina le selezioni dei radio button
            const selections = lastEval.selections;
            document.querySelectorAll('.competenza-radio').forEach(rb => rb.checked = false);

            selections.forEach(sel => {
                // ID: r_Reparto_sectionIndex_itemIndex_value
                const id = `r_${currentReparto.replace(/\s/g, '_')}_${sel.sectionIndex}_${sel.itemIndex}_${sel.value}`;
                const rb = document.getElementById(id);
                if (rb) {
                    rb.checked = true;
                }
            });

            updateScores();
            document.getElementById('btnStart').click(); // Abilita l'interfaccia
        }

        // Gestione degli eventi sui pulsanti Reparto
        document.querySelectorAll('.reparto-btn').forEach(btn => btn.addEventListener('click', e => {
            selectReparto(e.currentTarget.dataset.reparto);
        }));


        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            themeToggle.textContent = document.documentElement.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
        });

        // Init
        function init() {
            const initialReparto = document.querySelector('.reparto-btn').dataset.reparto;
            selectReparto(initialReparto, true);
            renderCompetences();
            renderNurses();
            updateScores();
        }
        init();

        // Reset dati locali da sidebar
        document.getElementById('clearLocal').addEventListener('click', () => {
            if (!confirm('Eliminare tutti i dati salvati localmente?')) return;
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        });

        //link VBHC
        document.getElementById('btnImport').addEventListener('click', () => {
            window.open('survey_vbhc_infermieri_sala_operatoria_html.html', '_blank');
        });</script>
</body>
</html>
